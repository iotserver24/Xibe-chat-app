name: Multi-Platform Build and Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        type: string
        default: '1.0.0'
      build_number:
        description: 'Build number (e.g., 1)'
        required: true
        type: string
        default: '1'
      release_type:
        description: 'Release type (draft: testing, beta: beta version, latest: stable release)'
        required: true
        type: choice
        options:
          - draft
          - beta
          - latest
        default: 'draft'

env:
  FLUTTER_VERSION: 'stable'
  # E2B Backend URL - can be set in GitHub repository variables (Settings > Secrets and variables > Actions > Variables)
  # If not set, defaults to: https://e2b.n92dev.us.kg
  E2B_BACKEND_URL: ${{ vars.E2B_BACKEND_URL || 'https://e2b.n92dev.us.kg' }}

jobs:
  # Android builds - APK and AAB
  build-android:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Update app version in pubspec.yaml
        run: |
          echo "ğŸ“ Updating version in pubspec.yaml to ${{ inputs.version }}+${{ inputs.build_number }}"
          sed -i "s/^version: .*/version: ${{ inputs.version }}+${{ inputs.build_number }}/" pubspec.yaml
          echo "âœ… Updated version in pubspec.yaml"
          grep "^version:" pubspec.yaml

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Get dependencies
        run: flutter pub get

      - name: Generate app icons
        run: |
          echo "ğŸ¨ Generating app icons..."
          flutter pub run flutter_launcher_icons
          echo "âœ… App icons generated"

      - name: Setup Android signing
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: |
          # Decode and save keystore
          if [ -n "$KEYSTORE_BASE64" ]; then
            # Remove all whitespace and newlines from base64 string, then decode
            # Using printf instead of echo to avoid adding extra newlines
            printf '%s' "$KEYSTORE_BASE64" | tr -d '\n\r\t ' | base64 -d > android/app/xibe-chat-app.jks
            
            # Verify the keystore was created successfully
            if [ ! -f android/app/xibe-chat-app.jks ]; then
              echo "âŒ Failed to create keystore file"
              exit 1
            fi
            
            # Set secure permissions on keystore
            chmod 600 android/app/xibe-chat-app.jks
            
            # Create key.properties file
            echo "storePassword=$KEYSTORE_PASSWORD" > android/key.properties
            echo "keyPassword=$KEY_PASSWORD" >> android/key.properties
            echo "keyAlias=${KEY_ALIAS:-xibe_chat_key}" >> android/key.properties
            echo "storeFile=xibe-chat-app.jks" >> android/key.properties
            
            echo "âœ… Release signing configured"
            echo "ğŸ“¦ Keystore size: $(wc -c < android/app/xibe-chat-app.jks) bytes"
          else
            echo "âš ï¸  No signing secrets found, using debug signing"
          fi

      - name: Build Universal APK
        run: flutter build apk --release --dart-define=E2B_BACKEND_URL=${{ env.E2B_BACKEND_URL }}

      - name: Build App Bundle (AAB)
        run: flutter build appbundle --release --dart-define=E2B_BACKEND_URL=${{ env.E2B_BACKEND_URL }}

      - name: Rename artifacts
        run: |
          mkdir -p artifacts/android
          cp build/app/outputs/flutter-apk/app-release.apk artifacts/android/xibe-chat-v${{ inputs.version }}-${{ inputs.build_number }}.apk
          cp build/app/outputs/bundle/release/app-release.aab artifacts/android/xibe-chat-v${{ inputs.version }}-${{ inputs.build_number }}.aab

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-builds
          path: artifacts/android/*
          retention-days: 1

  # Windows builds - Universal MSIX for Microsoft Store
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write
      actions: read
    
    strategy:
      matrix:
        arch: [x64, arm64]  # Building for x64 and arm64 separately for ZIP/NSIS, but universal MSIX
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Update app version in pubspec.yaml
        run: |
          Write-Host "Updating version in pubspec.yaml to ${{ inputs.version }}+${{ inputs.build_number }}"
          (Get-Content pubspec.yaml) -replace '^version: .*', "version: ${{ inputs.version }}+${{ inputs.build_number }}" | Set-Content pubspec.yaml
          Write-Host "Updated version in pubspec.yaml"
          Select-String -Path pubspec.yaml -Pattern '^version:'
        shell: powershell

      - name: Enable Windows Desktop
        run: flutter config --enable-windows-desktop

      - name: Create Windows platform files
        run: |
          if (!(Test-Path "windows")) {
            flutter create --platforms=windows .
          }
        shell: powershell

      - name: Get dependencies
        run: flutter pub get

      - name: Generate app icons
        run: |
          Write-Host "Generating app icons..."
          flutter pub run flutter_launcher_icons
          Write-Host "App icons generated"
        shell: powershell

      - name: Build Windows Release (${{ matrix.arch }})
        env:
          E2B_BACKEND_URL: ${{ env.E2B_BACKEND_URL }}
        run: |
          # Note: ARM64 support is experimental. On x64 runners, Flutter builds x64 by default.
          # For ARM64, Flutter may still output to x64 folder but the binary targets ARM64.
          flutter build windows --release --dart-define=E2B_BACKEND_URL=${{ env.E2B_BACKEND_URL }}
        shell: powershell

      - name: Build Universal MSIX for Microsoft Store (x64 only, once)
        if: matrix.arch == 'x64'
        run: |
          Write-Host "Building unsigned universal MSIX for Microsoft Store submission..."
          # The --store flag creates an unsigned MSIX package suitable for Microsoft Store submission
          # Microsoft Store will sign the package with their certificate
          # Note: Microsoft Store requires version format X.X.X.0 (revision must be 0)
          flutter pub run msix:create --store --version ${{ inputs.version }}.0
          Write-Host "Universal MSIX package created successfully"
        shell: powershell

      - name: Install NSIS and ImageMagick
        run: |
          Write-Host "Installing NSIS and ImageMagick via Chocolatey..."
          choco install nsis imagemagick -y --no-progress
          
          Write-Host "`nVerifying NSIS installation..."
          # Check common NSIS installation paths
          $nsisPaths = @(
            "C:\Program Files (x86)\NSIS\makensis.exe",
            "C:\Program Files\NSIS\makensis.exe",
            "$env:ProgramFiles(x86)\NSIS\makensis.exe",
            "$env:ProgramFiles\NSIS\makensis.exe"
          )
          
          $nsisPath = $null
          foreach ($path in $nsisPaths) {
            if (Test-Path $path) {
              Write-Host "âœ… NSIS found at: $path"
              & $path /VERSION
              $nsisPath = $path
              break
            }
          }
          
          if (-not $nsisPath) {
            Write-Host "âš ï¸  NSIS not found in expected locations, searching..."
            $searchResults = Get-ChildItem -Path "C:\Program Files*" -Filter "makensis.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($searchResults) {
              $nsisPath = $searchResults.FullName
              Write-Host "âœ… Found NSIS at: $nsisPath"
            } else {
              Write-Host "âŒ NSIS installation failed"
              exit 1
            }
          }
          
          # Add NSIS directory to PATH for subsequent steps
          $nsisDir = Split-Path -Parent $nsisPath
          Write-Host "`nAdding NSIS to PATH: $nsisDir"
          echo "$nsisDir" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          
          # Also set for current session
          $env:PATH = "$nsisDir;$env:PATH"
          
          Write-Host "`nâœ… NSIS installation verified and added to PATH"
        shell: powershell

      - name: Convert logo to NSIS format
        run: |
          # NSIS header image: 150x57 pixels BMP format
          # NSIS icon: ICO format
          if (Test-Path "logo.png") {
            # Resize and convert to BMP for header image (NSIS recommended size: 150x57)
            magick convert logo.png -resize 150x57^ -gravity center -extent 150x57 -format BMP installer-header.bmp
            Write-Host "Created installer header image (150x57 BMP)"
            
            # Convert to ICO format for installer icon (NSIS requires ICO, not PNG)
            # Create multi-resolution ICO file with common sizes
            magick convert logo.png -define icon:auto-resize=256,128,64,48,32,16 logo.ico
            Write-Host "Created installer icon (ICO format)"
          } elseif (Test-Path "windows\runner\resources\app_icon.ico") {
            # Use existing Windows app icon as fallback
            Copy-Item "windows\runner\resources\app_icon.ico" "logo.ico"
            Write-Host "Using existing app_icon.ico as installer icon"
          } else {
            Write-Host "Warning: logo.png not found, installer will use default logo"
          }
        shell: powershell

      - name: Create NSIS installer script
        run: |
          $nsisScript = @"
          !include "MUI2.nsh"
          !include "x64.nsh"
          
          Name "Xibe Chat v${{ inputs.version }}"
          OutFile "xibe-chat-installer-v${{ inputs.version }}-${{ inputs.build_number }}.exe"
          InstallDir "`$PROGRAMFILES\XibeChat"
          InstallDirRegKey HKCU "Software\XibeChat" "Install_Dir"
          
          # Set installer icon/logo
          !define MUI_HEADERIMAGE
          !define MUI_HEADERIMAGE_BITMAP "installer-header.bmp"
          !define MUI_WELCOMEFINISHPAGE_BITMAP "installer-header.bmp"
          !define MUI_ICON "logo.ico"
          !define MUI_UNICON "logo.ico"
          
          # Custom welcome page text with credits
          !define MUI_WELCOMEPAGE_TEXT "Welcome to Xibe Chat Setup!$\r$\n$\r$\nThis will install Xibe Chat v${{ inputs.version }} on your computer.$\r$\n$\r$\n$\r$\nBuilt by: R3AP3Reditz (Anish Kumar)$\r$\nPowered by: xibe.app for AI$\r$\n$\r$\nPortfolio: anishkumar.tech$\r$\nGitHub: github.com/iotserver24$\r$\n$\r$\nClick Next to continue."
          
          # Enable finish page run option
          !define MUI_FINISHPAGE_RUN
          !define MUI_FINISHPAGE_RUN_TEXT "Launch Xibe Chat"
          !define MUI_FINISHPAGE_RUN_FUNCTION "LaunchApp"
          
          # Custom finish page text with credits
          !define MUI_FINISHPAGE_TEXT "Xibe Chat has been installed on your computer!$\r$\n$\r$\nBuilt by: R3AP3Reditz (Anish Kumar)$\r$\nPowered by: xibe.app for AI$\r$\n$\r$\nVisit us:$\r$\n  Portfolio: anishkumar.tech$\r$\n  GitHub: github.com/iotserver24"
          
          !insertmacro MUI_PAGE_WELCOME
          !insertmacro MUI_PAGE_DIRECTORY
          !insertmacro MUI_PAGE_INSTFILES
          !insertmacro MUI_PAGE_FINISH
          
          !insertmacro MUI_LANGUAGE "English"
          
          Function LaunchApp
            Exec "`$INSTDIR\xibe_chat.exe"
          FunctionEnd
          
          Section "Install"
            SetOutPath "`$INSTDIR"
            File /r "build\windows\x64\runner\Release\*.*"
            CreateDirectory "`$SMPROGRAMS\XibeChat"
            CreateShortcut "`$SMPROGRAMS\XibeChat\Xibe Chat.lnk" "`$INSTDIR\xibe_chat.exe"
            CreateShortcut "`$DESKTOP\Xibe Chat.lnk" "`$INSTDIR\xibe_chat.exe"
            WriteRegStr HKCU "Software\XibeChat" "Install_Dir" "`$INSTDIR"
            
            # Register protocol handlers for deep links
            WriteRegStr HKCR "xibechat" "" "URL:xibechat Protocol"
            WriteRegStr HKCR "xibechat" "URL Protocol" ""
            WriteRegStr HKCR "xibechat\shell" "" ""
            WriteRegStr HKCR "xibechat\shell\open" "" ""
            WriteRegStr HKCR "xibechat\shell\open\command" "" "`$`\`"`$INSTDIR\xibe_chat.exe`$`\`" `$`\`"%1`$`\`""
            
            # Register HTTPS protocol handler for xibechat.app domain
            WriteRegStr HKCR "xibechat.app" "" "URL:xibechat.app Protocol"
            WriteRegStr HKCR "xibechat.app" "URL Protocol" ""
            WriteRegStr HKCR "xibechat.app\shell" "" ""
            WriteRegStr HKCR "xibechat.app\shell\open" "" ""
            WriteRegStr HKCR "xibechat.app\shell\open\command" "" "`$`\`"`$INSTDIR\xibe_chat.exe`$`\`" `$`\`"%1`$`\`""
          SectionEnd
          
          Section "Uninstall"
            RMDir /r "`$INSTDIR"
            RMDir /r "`$SMPROGRAMS\XibeChat"
            Delete "`$DESKTOP\Xibe Chat.lnk"
            DeleteRegKey HKCU "Software\XibeChat"
            
            # Unregister protocol handlers
            DeleteRegKey HKCR "xibechat"
            DeleteRegKey HKCR "xibechat.app"
          SectionEnd
          "@
          $nsisScript | Out-File -FilePath "xibe-chat-installer.nsi" -Encoding UTF8
        shell: powershell

      - name: Build NSIS installer
        run: |
          # Verify required files exist for NSIS
          $missingFiles = @()
          
          if (-not (Test-Path "installer-header.bmp")) {
            $missingFiles += "installer-header.bmp"
          }
          
          if (-not (Test-Path "logo.ico")) {
            # Try to use existing app_icon.ico as fallback
            if (Test-Path "windows\runner\resources\app_icon.ico") {
              Copy-Item "windows\runner\resources\app_icon.ico" "logo.ico"
              Write-Host "Using app_icon.ico as installer icon"
            } else {
              $missingFiles += "logo.ico"
            }
          }
          
          if ($missingFiles.Count -gt 0) {
            Write-Host "âš ï¸  Warning: Missing files for NSIS: $($missingFiles -join ', ')"
            Write-Host "NSIS may use default images"
          } else {
            Write-Host "âœ… All required files present for NSIS installer"
          }
          
          # Try to find NSIS using 'where' command first (checks PATH)
          Write-Host "`nLocating NSIS..."
          $nsisPath = $null
          
          try {
            $whereResult = where.exe makensis.exe 2>$null
            if ($whereResult -and (Test-Path $whereResult[0])) {
              $nsisPath = $whereResult[0]
              Write-Host "âœ… Found NSIS in PATH: $nsisPath"
            }
          } catch {
            Write-Host "NSIS not found in PATH, checking standard locations..."
          }
          
          # Fallback to checking standard locations
          if (-not $nsisPath) {
            $nsisPaths = @(
              "C:\Program Files (x86)\NSIS\makensis.exe",
              "C:\Program Files\NSIS\makensis.exe",
              "$env:ProgramFiles(x86)\NSIS\makensis.exe",
              "$env:ProgramFiles\NSIS\makensis.exe"
            )
            
            foreach ($path in $nsisPaths) {
              if (Test-Path $path) {
                $nsisPath = $path
                Write-Host "âœ… Found NSIS at: $nsisPath"
                break
              }
            }
          }
          
          # Last resort: search the filesystem
          if (-not $nsisPath) {
            Write-Host "âš ï¸  Performing filesystem search for NSIS..."
            $searchResults = Get-ChildItem -Path "C:\Program Files*" -Filter "makensis.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($searchResults) {
              $nsisPath = $searchResults.FullName
              Write-Host "âœ… Found NSIS at: $nsisPath"
            }
          }
          
          if ($nsisPath) {
            Write-Host "`nBuilding NSIS installer..."
            Write-Host "Using: $nsisPath"
            & $nsisPath xibe-chat-installer.nsi
            
            if ($LASTEXITCODE -eq 0) {
              Write-Host "âœ… NSIS installer created successfully"
              
              # Verify the installer was created
              $expectedInstaller = "xibe-chat-installer-v${{ inputs.version }}-${{ inputs.build_number }}.exe"
              if (Test-Path $expectedInstaller) {
                $installerSize = (Get-Item $expectedInstaller).Length / 1MB
                Write-Host "âœ… Installer file exists: $expectedInstaller ($([math]::Round($installerSize, 2)) MB)"
              } else {
                Write-Host "âš ï¸  Warning: Installer executable not found at expected location"
              }
            } else {
              Write-Host "âŒ NSIS installer build failed with exit code: $LASTEXITCODE"
              exit 1
            }
          } else {
            Write-Host "âŒ NSIS not found in any location"
            Write-Host "This should not happen as NSIS was installed in a previous step."
            Write-Host "Please check the 'Install NSIS and ImageMagick' step logs."
            exit 1
          }
        shell: powershell

      - name: Package Windows artifacts
        run: |
          New-Item -ItemType Directory -Force -Path "artifacts\windows-${{ matrix.arch }}"
          
          # Determine the actual build output folder
          # Flutter may output ARM64 builds to x64 folder when cross-compiling
          $buildPath = "build\windows\x64\runner\Release"
          if (Test-Path "build\windows\${{ matrix.arch }}\runner\Release") {
            $buildPath = "build\windows\${{ matrix.arch }}\runner\Release"
          }
          
          Write-Host "Using build path: $buildPath"
          
          # List contents to debug
          if (Test-Path $buildPath) {
            Write-Host "Contents of build path:"
            Get-ChildItem -Path $buildPath | Format-Table Name, Length
          } else {
            Write-Host "Build path does not exist!"
            Write-Host "Available paths in build\windows:"
            if (Test-Path "build\windows") {
              Get-ChildItem -Path "build\windows" -Recurse -Directory | Select-Object -First 10 | Format-Table FullName
            }
          }
          
          # Copy EXE build
          if (Test-Path $buildPath) {
            New-Item -ItemType Directory -Force -Path "artifacts\windows-${{ matrix.arch }}\xibe-chat-windows-${{ matrix.arch }}"
            Copy-Item -Path "$buildPath\*" -Destination "artifacts\windows-${{ matrix.arch }}\xibe-chat-windows-${{ matrix.arch }}" -Recurse -Force
            
            # Create ZIP of EXE
            Compress-Archive -Path "artifacts\windows-${{ matrix.arch }}\xibe-chat-windows-${{ matrix.arch }}\*" -DestinationPath "artifacts\windows-${{ matrix.arch }}\xibe-chat-windows-${{ matrix.arch }}-v${{ inputs.version }}-${{ inputs.build_number }}.zip" -Force
            
            Write-Host "Created Windows executable ZIP"
            
            # Remove unzipped folder to save space
            Remove-Item -Path "artifacts\windows-${{ matrix.arch }}\xibe-chat-windows-${{ matrix.arch }}" -Recurse -Force
          } else {
            Write-Host "Build path not found, skipping EXE packaging"
          }
          
          # Copy Universal MSIX (only for x64 build to avoid duplication)
          if ("${{ matrix.arch }}" -eq "x64") {
            $msixFile = Get-ChildItem -Path . -Filter "*.msix" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($msixFile) {
              Copy-Item -Path $msixFile.FullName -Destination "artifacts\windows-${{ matrix.arch }}\xibe-chat-windows-universal-store-v${{ inputs.version }}-${{ inputs.build_number }}.msix" -Force
              Write-Host "Copied Universal MSIX for Microsoft Store (unsigned)"
            } else {
              Write-Host "MSIX file not found"
            }
          }
          
          # Copy NSIS installer
          $nsisInstaller = "xibe-chat-installer-v${{ inputs.version }}-${{ inputs.build_number }}.exe"
          if (Test-Path $nsisInstaller) {
            Copy-Item -Path $nsisInstaller -Destination "artifacts\windows-${{ matrix.arch }}\xibe-chat-installer-${{ matrix.arch }}-v${{ inputs.version }}-${{ inputs.build_number }}.exe" -Force
            Write-Host "Copied NSIS installer"
          } else {
            Write-Host "NSIS installer not found"
          }
        shell: powershell

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.arch }}-builds
          path: artifacts/windows-${{ matrix.arch }}/*
          retention-days: 1

  # macOS builds - Matrix for x64 (Intel) and arm64 (Apple Silicon)
  # Note: Flutter creates universal binaries by default, but we maintain separate
  # artifact names for x64 and arm64 for user clarity and download preferences
  build-macos:
    runs-on: macos-latest
    permissions:
      contents: write
      actions: read
    
    strategy:
      matrix:
        arch: [x64, arm64]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Update app version in pubspec.yaml
        run: |
          echo "ğŸ“ Updating version in pubspec.yaml to ${{ inputs.version }}+${{ inputs.build_number }}"
          sed -i.bak "s/^version: .*/version: ${{ inputs.version }}+${{ inputs.build_number }}/" pubspec.yaml
          rm pubspec.yaml.bak
          echo "âœ… Updated version in pubspec.yaml"
          grep "^version:" pubspec.yaml

      - name: Enable macOS Desktop
        run: flutter config --enable-macos-desktop

      - name: Create macOS platform files
        run: |
          if [ ! -d "macos" ]; then
            flutter create --platforms=macos .
          fi

      - name: Get dependencies
        run: flutter pub get

      - name: Generate app icons
        run: |
          echo "ğŸ¨ Generating app icons..."
          flutter pub run flutter_launcher_icons
          echo "âœ… App icons generated"

      - name: Configure macOS deep links
        run: |
          # Add deep link URL schemes to Info.plist
          if [ -f "macos/Runner/Info.plist" ]; then
            # Use PlistBuddy to add URL schemes if not already present
            /usr/libexec/PlistBuddy -c "Add :CFBundleURLTypes array" macos/Runner/Info.plist 2>/dev/null || true
            /usr/libexec/PlistBuddy -c "Add :CFBundleURLTypes:0 dict" macos/Runner/Info.plist 2>/dev/null || true
            /usr/libexec/PlistBuddy -c "Add :CFBundleURLTypes:0:CFBundleURLSchemes array" macos/Runner/Info.plist 2>/dev/null || true
            /usr/libexec/PlistBuddy -c "Add :CFBundleURLTypes:0:CFBundleURLSchemes:0 string xibechat" macos/Runner/Info.plist 2>/dev/null || true
            /usr/libexec/PlistBuddy -c "Add :CFBundleURLTypes:1 dict" macos/Runner/Info.plist 2>/dev/null || true
            /usr/libexec/PlistBuddy -c "Add :CFBundleURLTypes:1:CFBundleURLName string xibechat.app" macos/Runner/Info.plist 2>/dev/null || true
            /usr/libexec/PlistBuddy -c "Add :CFBundleURLTypes:1:CFBundleURLSchemes array" macos/Runner/Info.plist 2>/dev/null || true
            /usr/libexec/PlistBuddy -c "Add :CFBundleURLTypes:1:CFBundleURLSchemes:0 string https" macos/Runner/Info.plist 2>/dev/null || true
            echo "âœ… Configured macOS deep links"
          else
            echo "âš ï¸  macOS Info.plist not found, skipping deep link configuration"
          fi

      - name: Build macOS app
        run: |
          # Flutter builds universal binaries by default for macOS (both Intel and Apple Silicon)
          # The --target-platform flag is not supported for macOS builds
          flutter build macos --release --dart-define=E2B_BACKEND_URL=${{ env.E2B_BACKEND_URL }}

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create DMG
        run: |
          mkdir -p artifacts/macos-${{ matrix.arch }}
          
          # Create DMG from .app bundle
          create-dmg \
            --volname "Xibe Chat" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --app-drop-link 600 185 \
            "artifacts/macos-${{ matrix.arch }}/xibe-chat-macos-${{ matrix.arch }}-v${{ inputs.version }}-${{ inputs.build_number }}.dmg" \
            "build/macos/Build/Products/Release/xibe_chat.app" || true
          
          # Fallback: Create simple DMG if create-dmg fails
          if [ ! -f "artifacts/macos-${{ matrix.arch }}/xibe-chat-macos-${{ matrix.arch }}-v${{ inputs.version }}-${{ inputs.build_number }}.dmg" ]; then
            hdiutil create -volname "Xibe Chat" -srcfolder "build/macos/Build/Products/Release/xibe_chat.app" -ov -format UDZO "artifacts/macos-${{ matrix.arch }}/xibe-chat-macos-${{ matrix.arch }}-v${{ inputs.version }}-${{ inputs.build_number }}.dmg"
          fi
          
          # Create ZIP
          cd build/macos/Build/Products/Release
          zip -r "../../../../../artifacts/macos-${{ matrix.arch }}/xibe-chat-macos-${{ matrix.arch }}-v${{ inputs.version }}-${{ inputs.build_number }}.zip" xibe_chat.app

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}-builds
          path: artifacts/macos-${{ matrix.arch }}/*
          retention-days: 1

  # Linux builds - Matrix for x64, arm64, and armv7 with all package types
  build-linux:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    
    strategy:
      matrix:
        arch: [x64, arm64, armv7]  # Build for x64 (amd64), arm64 (aarch64), and armv7 (armhf)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Linux dependencies and cross-compilation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev rpm
          
          # Install cross-compilation toolchains for ARM architectures
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu binutils-aarch64-linux-gnu
            echo "Installed ARM64 cross-compilation toolchain"
          elif [ "${{ matrix.arch }}" = "armv7" ]; then
            sudo apt-get install -y gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf binutils-arm-linux-gnueabihf
            echo "Installed ARMv7 cross-compilation toolchain"
          fi

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Update app version in pubspec.yaml
        run: |
          echo "ğŸ“ Updating version in pubspec.yaml to ${{ inputs.version }}+${{ inputs.build_number }}"
          sed -i "s/^version: .*/version: ${{ inputs.version }}+${{ inputs.build_number }}/" pubspec.yaml
          echo "âœ… Updated version in pubspec.yaml"
          grep "^version:" pubspec.yaml

      - name: Enable Linux Desktop
        run: flutter config --enable-linux-desktop

      - name: Create Linux platform files
        run: |
          if [ ! -d "linux" ]; then
            flutter create --platforms=linux .
          fi

      - name: Get dependencies
        run: flutter pub get

      - name: Generate app icons
        run: |
          echo "ğŸ¨ Generating app icons..."
          flutter pub run flutter_launcher_icons
          echo "âœ… App icons generated"

      - name: Register Linux protocol handler
        run: |
          # Register xibechat:// protocol handler for Linux
          # This creates the mime type and desktop entry association
          sudo mkdir -p /usr/share/mime/packages
          cat > /tmp/xibe-chat-protocol.xml <<EOL
          <?xml version="1.0" encoding="UTF-8"?>
          <mime-info xmlns="http://www.freedesktop.org/standards/shared-mime-info">
            <mime-type type="x-scheme-handler/xibechat">
              <comment>Xibe Chat Protocol</comment>
              <glob pattern="xibechat:*"/>
            </mime-type>
          </mime-info>
          EOL
          sudo cp /tmp/xibe-chat-protocol.xml /usr/share/mime/packages/xibe-chat-protocol.xml
          sudo update-mime-database /usr/share/mime
          echo "âœ… Registered Linux protocol handler"

      - name: Build Linux Release (${{ matrix.arch }})
        run: |
          # Note: Flutter doesn't natively support cross-compilation for Linux
          # For ARM builds, we build on x64 and package the binaries
          # In production, these should ideally be built on native ARM runners
          if [ "${{ matrix.arch }}" = "x64" ]; then
            flutter build linux --release --dart-define=E2B_BACKEND_URL=${{ env.E2B_BACKEND_URL }}
          else
            # For ARM architectures, build x64 first (users will need native ARM builds for actual use)
            # This is a limitation of GitHub Actions - ideally use native ARM runners
            echo "âš ï¸  Building x64 binary (ARM cross-compilation not fully supported by Flutter on GitHub Actions)"
            echo "âš ï¸  For production ARM builds, use native ARM hardware"
            flutter build linux --release --dart-define=E2B_BACKEND_URL=${{ env.E2B_BACKEND_URL }}
          fi

      - name: Install AppImage, DEB, and RPM creation tools
        run: |
          # Install appimagetool for the appropriate architecture
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-aarch64.AppImage -O appimagetool
          elif [ "${{ matrix.arch }}" = "armv7" ]; then
            wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-armhf.AppImage -O appimagetool || \
            wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage -O appimagetool
          else
            wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage -O appimagetool
          fi
          chmod +x appimagetool
          sudo mv appimagetool /usr/local/bin/appimagetool

      - name: Create AppImage
        run: |
          mkdir -p artifacts/linux-${{ matrix.arch }}
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/lib
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          
          # Determine build path (Flutter always outputs to x64 on x64 runners)
          BUILD_PATH="build/linux/x64/release/bundle"
          if [ -d "build/linux/${{ matrix.arch }}/release/bundle" ]; then
            BUILD_PATH="build/linux/${{ matrix.arch }}/release/bundle"
          fi
          
          # Copy application files
          cp -r "$BUILD_PATH"/* AppDir/usr/bin/
          
          # Create desktop file with deep link protocol support
          cat > AppDir/usr/share/applications/xibe-chat.desktop <<EOL
          [Desktop Entry]
          Name=Xibe Chat
          Exec=xibe_chat %u
          Icon=xibe-chat
          Type=Application
          Categories=Network;Chat;
          MimeType=x-scheme-handler/xibechat;
          EOL
          
          # Copy icon if exists
          if [ -f "android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png" ]; then
            cp android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png AppDir/usr/share/icons/hicolor/256x256/apps/xibe-chat.png
          fi
          
          # Create AppRun
          cat > AppDir/AppRun <<'EOL'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin/:${HERE}/usr/sbin/:${HERE}/usr/games/:${HERE}/bin/:${HERE}/sbin/${PATH:+:$PATH}"
          export LD_LIBRARY_PATH="${HERE}/usr/lib/:${HERE}/usr/lib/i386-linux-gnu/:${HERE}/usr/lib/x86_64-linux-gnu/:${HERE}/usr/lib/aarch64-linux-gnu/:${HERE}/usr/lib/arm-linux-gnueabihf/:${HERE}/usr/lib32/:${HERE}/usr/lib64/:${HERE}/lib/:${HERE}/lib/i386-linux-gnu/:${HERE}/lib/x86_64-linux-gnu/:${HERE}/lib/aarch64-linux-gnu/:${HERE}/lib/arm-linux-gnueabihf/:${HERE}/lib32/:${HERE}/lib64/${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}"
          export PYTHONPATH="${HERE}/usr/share/pyshared/${PYTHONPATH:+:$PYTHONPATH}"
          export XDG_DATA_DIRS="${HERE}/usr/share/${XDG_DATA_DIRS:+:$XDG_DATA_DIRS}"
          export PERLLIB="${HERE}/usr/share/perl5/:${HERE}/usr/lib/perl5/${PERLLIB:+:$PERLLIB}"
          export GSETTINGS_SCHEMA_DIR="${HERE}/usr/share/glib-2.0/schemas/${GSETTINGS_SCHEMA_DIR:+:$GSETTINGS_SCHEMA_DIR}"
          export QT_PLUGIN_PATH="${HERE}/usr/lib/qt4/plugins/:${HERE}/usr/lib/i386-linux-gnu/qt4/plugins/:${HERE}/usr/lib/x86_64-linux-gnu/qt4/plugins/:${HERE}/usr/lib32/qt4/plugins/:${HERE}/usr/lib64/qt4/plugins/:${HERE}/usr/lib/qt5/plugins/:${HERE}/usr/lib/i386-linux-gnu/qt5/plugins/:${HERE}/usr/lib/x86_64-linux-gnu/qt5/plugins/:${HERE}/usr/lib32/qt5/plugins/:${HERE}/usr/lib64/qt5/plugins/${QT_PLUGIN_PATH:+:$QT_PLUGIN_PATH}"
          EXEC=$(grep -e '^Exec=.*' "${HERE}"/*.desktop | head -n 1 | cut -d "=" -f 2 | cut -d " " -f 1)
          exec "${HERE}/usr/bin/${EXEC}" "$@"
          EOL
          
          chmod +x AppDir/AppRun
          
          # Set ARCH environment variable for appimagetool
          if [ "${{ matrix.arch }}" = "x64" ]; then
            APPIMAGE_ARCH="x86_64"
          elif [ "${{ matrix.arch }}" = "arm64" ]; then
            APPIMAGE_ARCH="aarch64"
          elif [ "${{ matrix.arch }}" = "armv7" ]; then
            APPIMAGE_ARCH="armhf"
          fi
          
          # Build AppImage
          ARCH=$APPIMAGE_ARCH appimagetool AppDir "artifacts/linux-${{ matrix.arch }}/xibe-chat-linux-${{ matrix.arch }}-v${{ inputs.version }}-${{ inputs.build_number }}.AppImage" || {
            echo "::warning::AppImage creation failed. This may be due to missing desktop integration files or appimagetool issues."
            echo "DEB, RPM, and ZIP packages will still be available."
          }

      - name: Create DEB package
        run: |
          mkdir -p deb-package/DEBIAN
          mkdir -p deb-package/opt/xibe-chat
          mkdir -p deb-package/usr/share/applications
          mkdir -p deb-package/usr/share/icons/hicolor/256x256/apps
          
          # Determine build path
          BUILD_PATH="build/linux/x64/release/bundle"
          if [ -d "build/linux/${{ matrix.arch }}/release/bundle" ]; then
            BUILD_PATH="build/linux/${{ matrix.arch }}/release/bundle"
          fi
          
          # Copy application
          cp -r "$BUILD_PATH"/* deb-package/opt/xibe-chat/
          
          # Determine Debian architecture name
          if [ "${{ matrix.arch }}" = "x64" ]; then
            DEB_ARCH="amd64"
          elif [ "${{ matrix.arch }}" = "arm64" ]; then
            DEB_ARCH="arm64"
          elif [ "${{ matrix.arch }}" = "armv7" ]; then
            DEB_ARCH="armhf"
          fi
          
          # Create control file
          cat > deb-package/DEBIAN/control <<EOL
          Package: xibe-chat
          Version: ${{ inputs.version }}-${{ inputs.build_number }}
          Section: net
          Priority: optional
          Architecture: ${DEB_ARCH}
          Maintainer: XibeChat <support@xibechat.com>
          Description: Xibe Chat - AI-powered chat application
           A modern AI chat application built with Flutter
          EOL
          
          # Create desktop file with deep link protocol support
          cat > deb-package/usr/share/applications/xibe-chat.desktop <<EOL
          [Desktop Entry]
          Name=Xibe Chat
          Exec=/opt/xibe-chat/xibe_chat %u
          Icon=xibe-chat
          Type=Application
          Categories=Network;Chat;
          MimeType=x-scheme-handler/xibechat;
          EOL
          
          # Copy icon
          if [ -f "android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png" ]; then
            cp android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png deb-package/usr/share/icons/hicolor/256x256/apps/xibe-chat.png
          fi
          
          # Build DEB
          dpkg-deb --build deb-package "artifacts/linux-${{ matrix.arch }}/xibe-chat-linux-${{ matrix.arch }}-v${{ inputs.version }}-${{ inputs.build_number }}.deb"

      - name: Create RPM package
        run: |
          mkdir -p rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          mkdir -p rpmbuild/BUILD/xibe-chat-${{ inputs.version }}
          
          # Determine build path
          BUILD_PATH="build/linux/x64/release/bundle"
          if [ -d "build/linux/${{ matrix.arch }}/release/bundle" ]; then
            BUILD_PATH="build/linux/${{ matrix.arch }}/release/bundle"
          fi
          
          # Copy application files
          mkdir -p rpmbuild/BUILD/xibe-chat-${{ inputs.version }}/opt/xibe-chat
          mkdir -p rpmbuild/BUILD/xibe-chat-${{ inputs.version }}/usr/share/applications
          mkdir -p rpmbuild/BUILD/xibe-chat-${{ inputs.version }}/usr/share/icons/hicolor/256x256/apps
          
          cp -r "$BUILD_PATH"/* rpmbuild/BUILD/xibe-chat-${{ inputs.version }}/opt/xibe-chat/
          
          # Create desktop file with deep link protocol support
          cat > rpmbuild/BUILD/xibe-chat-${{ inputs.version }}/usr/share/applications/xibe-chat.desktop <<EOL
          [Desktop Entry]
          Name=Xibe Chat
          Exec=/opt/xibe-chat/xibe_chat %u
          Icon=xibe-chat
          Type=Application
          Categories=Network;Chat;
          MimeType=x-scheme-handler/xibechat;
          EOL
          
          # Copy icon
          if [ -f "android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png" ]; then
            cp android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png rpmbuild/BUILD/xibe-chat-${{ inputs.version }}/usr/share/icons/hicolor/256x256/apps/xibe-chat.png
          fi
          
          # Determine RPM architecture name
          if [ "${{ matrix.arch }}" = "x64" ]; then
            RPM_ARCH="x86_64"
          elif [ "${{ matrix.arch }}" = "arm64" ]; then
            RPM_ARCH="aarch64"
          elif [ "${{ matrix.arch }}" = "armv7" ]; then
            RPM_ARCH="armv7hl"
          fi
          
          # Create RPM spec file
          cat > rpmbuild/SPECS/xibe-chat.spec <<EOL
          Name:           xibe-chat
          Version:        ${{ inputs.version }}
          Release:        ${{ inputs.build_number }}
          Summary:        Xibe Chat - AI-powered chat application
          License:        MIT
          URL:            https://github.com/iotserver24/xibe-chat
          
          %description
          A modern AI chat application built with Flutter
          
          %install
          mkdir -p %{buildroot}/opt/xibe-chat
          mkdir -p %{buildroot}/usr/share/applications
          mkdir -p %{buildroot}/usr/share/icons/hicolor/256x256/apps
          cp -r %{_builddir}/xibe-chat-${{ inputs.version }}/opt/xibe-chat/* %{buildroot}/opt/xibe-chat/
          cp %{_builddir}/xibe-chat-${{ inputs.version }}/usr/share/applications/xibe-chat.desktop %{buildroot}/usr/share/applications/
          if [ -f "%{_builddir}/xibe-chat-${{ inputs.version }}/usr/share/icons/hicolor/256x256/apps/xibe-chat.png" ]; then
            cp %{_builddir}/xibe-chat-${{ inputs.version }}/usr/share/icons/hicolor/256x256/apps/xibe-chat.png %{buildroot}/usr/share/icons/hicolor/256x256/apps/
          fi
          
          %files
          /opt/xibe-chat/*
          /usr/share/applications/xibe-chat.desktop
          /usr/share/icons/hicolor/256x256/apps/xibe-chat.png
          
          %changelog
          * $(date "+%a %b %d %Y") XibeChat <support@xibechat.com> - ${{ inputs.version }}-${{ inputs.build_number }}
          - Release ${{ inputs.version }}-${{ inputs.build_number }}
          EOL
          
          # Build RPM with target architecture
          rpmbuild --define "_topdir $(pwd)/rpmbuild" --target ${RPM_ARCH} -bb rpmbuild/SPECS/xibe-chat.spec
          
          # Copy RPM to artifacts
          find rpmbuild/RPMS -name "*.rpm" -exec cp {} "artifacts/linux-${{ matrix.arch }}/xibe-chat-linux-${{ matrix.arch }}-v${{ inputs.version }}-${{ inputs.build_number }}.rpm" \;

      - name: Create ZIP archive
        run: |
          # Determine build path
          BUILD_PATH="build/linux/x64/release/bundle"
          if [ -d "build/linux/${{ matrix.arch }}/release/bundle" ]; then
            BUILD_PATH="build/linux/${{ matrix.arch }}/release/bundle"
          fi
          
          cd "$BUILD_PATH"
          zip -r "../../../../../artifacts/linux-${{ matrix.arch }}/xibe-chat-linux-${{ matrix.arch }}-v${{ inputs.version }}-${{ inputs.build_number }}.zip" .

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.arch }}-builds
          path: artifacts/linux-${{ matrix.arch }}/*
          retention-days: 1

  # iOS builds - IPA (requires proper signing)
  build-ios:
    runs-on: macos-latest
    permissions:
      contents: write
      actions: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Update app version in pubspec.yaml
        run: |
          echo "ğŸ“ Updating version in pubspec.yaml to ${{ inputs.version }}+${{ inputs.build_number }}"
          sed -i.bak "s/^version: .*/version: ${{ inputs.version }}+${{ inputs.build_number }}/" pubspec.yaml
          rm pubspec.yaml.bak
          echo "âœ… Updated version in pubspec.yaml"
          grep "^version:" pubspec.yaml

      - name: Create iOS platform files
        run: |
          if [ ! -d "ios" ]; then
            flutter create --platforms=ios .
          fi

      - name: Get dependencies
        run: flutter pub get

      - name: Enable iOS icon generation
        run: |
          # Temporarily enable iOS icon generation now that iOS directory exists
          sed -i.bak 's/ios: false/ios: true/' pubspec.yaml
          rm pubspec.yaml.bak

      - name: Generate app icons
        run: |
          echo "ğŸ¨ Generating app icons..."
          flutter pub run flutter_launcher_icons
          echo "âœ… App icons generated"

      - name: Configure iOS deep links
        run: |
          # Add deep link URL schemes to Info.plist
          if [ -f "ios/Runner/Info.plist" ]; then
            # Use PlistBuddy to add URL schemes if not already present
            /usr/libexec/PlistBuddy -c "Add :CFBundleURLTypes array" ios/Runner/Info.plist 2>/dev/null || true
            /usr/libexec/PlistBuddy -c "Add :CFBundleURLTypes:0 dict" ios/Runner/Info.plist 2>/dev/null || true
            /usr/libexec/PlistBuddy -c "Add :CFBundleURLTypes:0:CFBundleURLSchemes array" ios/Runner/Info.plist 2>/dev/null || true
            /usr/libexec/PlistBuddy -c "Add :CFBundleURLTypes:0:CFBundleURLSchemes:0 string xibechat" ios/Runner/Info.plist 2>/dev/null || true
            /usr/libexec/PlistBuddy -c "Add :CFBundleURLTypes:1 dict" ios/Runner/Info.plist 2>/dev/null || true
            /usr/libexec/PlistBuddy -c "Add :CFBundleURLTypes:1:CFBundleURLName string xibechat.app" ios/Runner/Info.plist 2>/dev/null || true
            /usr/libexec/PlistBuddy -c "Add :CFBundleURLTypes:1:CFBundleURLSchemes array" ios/Runner/Info.plist 2>/dev/null || true
            /usr/libexec/PlistBuddy -c "Add :CFBundleURLTypes:1:CFBundleURLSchemes:0 string https" ios/Runner/Info.plist 2>/dev/null || true
            echo "âœ… Configured iOS deep links"
          else
            echo "âš ï¸  iOS Info.plist not found, skipping deep link configuration"
          fi

      - name: Configure iOS project for unsigned build
        run: |
          # Disable code signing in Xcode project to allow --no-codesign builds
          # This is required for CI/CD environments without signing certificates
          if [ -f "ios/Runner.xcodeproj/project.pbxproj" ]; then
            sed -i.bak 's/CODE_SIGN_IDENTITY = "iPhone Developer"/CODE_SIGN_IDENTITY = ""/g' ios/Runner.xcodeproj/project.pbxproj
            sed -i.bak 's/CODE_SIGN_IDENTITY = "iPhone Distribution"/CODE_SIGN_IDENTITY = ""/g' ios/Runner.xcodeproj/project.pbxproj
            sed -i.bak 's/DEVELOPMENT_TEAM = .*/DEVELOPMENT_TEAM = "";/g' ios/Runner.xcodeproj/project.pbxproj
            # Also disable automatic signing
            sed -i.bak 's/ProvisioningStyle = Automatic;/ProvisioningStyle = Manual;/g' ios/Runner.xcodeproj/project.pbxproj
            rm -f ios/Runner.xcodeproj/project.pbxproj.bak
            echo "âœ… Configured iOS project for unsigned build"
          else
            echo "âš ï¸  iOS project file not found, skipping configuration"
          fi

      - name: Build iOS (unsigned)
        run: |
          flutter build ios --release --no-codesign --dart-define=E2B_BACKEND_URL=${{ env.E2B_BACKEND_URL }}

      - name: Create unsigned IPA
        run: |
          mkdir -p artifacts/ios
          mkdir -p Payload
          cp -r build/ios/iphoneos/Runner.app Payload/
          zip -r "artifacts/ios/xibe-chat-ios-unsigned-v${{ inputs.version }}-${{ inputs.build_number }}.ipa" Payload
          rm -rf Payload

      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-builds
          path: artifacts/ios/*
          retention-days: 1

  # Create GitHub Release with all artifacts
  create-release:
    needs: [build-android, build-windows, build-macos, build-linux, build-ios]
    if: always()
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      actions: read
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: |
          echo "ğŸ“¦ Downloaded artifacts:"
          ls -R artifacts

      - name: Organize release files
        run: |
          mkdir -p release-files
          
          # Copy all artifacts to release-files
          find artifacts -type f \( -name "*.apk" -o -name "*.aab" -o -name "*.zip" -o -name "*.msix" -o -name "*.dmg" -o -name "*.deb" -o -name "*.rpm" -o -name "*.AppImage" -o -name "*.tar.gz" -o -name "*.ipa" -o -name "*.exe" \) -exec cp {} release-files/ \;
          
          echo ""
          echo "ğŸ“¦ Release files ready:"
          ls -lh release-files/ || echo "No files available"
          
          # Check if we have at least one artifact
          if [ "$(ls -A release-files/)" ]; then
            echo "HAS_ARTIFACTS=true" >> $GITHUB_ENV
            echo "âœ… Artifacts available for release"
          else
            echo "HAS_ARTIFACTS=false" >> $GITHUB_ENV
            echo "âŒ No artifacts available for release"
          fi

      - name: Create Git Tag
        if: env.HAS_ARTIFACTS == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const tag = `v${{ inputs.version }}-${{ inputs.build_number }}`;
            try {
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/tags/${tag}`,
                sha: context.sha
              });
              console.log(`âœ“ Created tag: ${tag}`);
            } catch (error) {
              if (error.status === 422) {
                console.log(`âš  Tag ${tag} already exists, using existing tag`);
              } else {
                throw error;
              }
            }

      - name: Create GitHub Release
        if: env.HAS_ARTIFACTS == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}-${{ inputs.build_number }}
          name: Xibe Chat v${{ inputs.version }}-${{ inputs.build_number }} (${{ inputs.release_type }})
          draft: ${{ inputs.release_type == 'draft' }}
          prerelease: ${{ inputs.release_type == 'beta' }}
          files: release-files/*
          fail_on_unmatched_files: false
          body: |
            ## ğŸš€ Xibe Chat v${{ inputs.version }}-${{ inputs.build_number }}
            
            Multi-platform release with builds for all major operating systems!
            
            ### ğŸ“¥ Download Options
            
            #### ğŸ“± **Android**
            - `xibe-chat-v${{ inputs.version }}-${{ inputs.build_number }}.apk` - Universal APK (all devices)
            - `xibe-chat-v${{ inputs.version }}-${{ inputs.build_number }}.aab` - App Bundle (for Play Store)
            
            #### ğŸ’» **Windows**
            - `xibe-chat-installer-x64-v${{ inputs.version }}-${{ inputs.build_number }}.exe` - NSIS installer (recommended for x64)
            - `xibe-chat-installer-arm64-v${{ inputs.version }}-${{ inputs.build_number }}.exe` - NSIS installer (recommended for ARM64)
            - `xibe-chat-windows-universal-store-v${{ inputs.version }}-${{ inputs.build_number }}.msix` - **Universal MSIX for Microsoft Store** (unsigned, ready for Store submission)
            - `xibe-chat-windows-x64-v${{ inputs.version }}-${{ inputs.build_number }}.zip` - Portable ZIP (x64)
            - `xibe-chat-windows-arm64-v${{ inputs.version }}-${{ inputs.build_number }}.zip` - Portable ZIP (ARM64)
            
            #### ğŸ **macOS**
            - `xibe-chat-macos-x64-v${{ inputs.version }}-${{ inputs.build_number }}.dmg` - Intel Mac installer
            - `xibe-chat-macos-arm64-v${{ inputs.version }}-${{ inputs.build_number }}.dmg` - Apple Silicon installer
            - `xibe-chat-macos-x64-v${{ inputs.version }}-${{ inputs.build_number }}.zip` - Intel Mac portable
            - `xibe-chat-macos-arm64-v${{ inputs.version }}-${{ inputs.build_number }}.zip` - Apple Silicon portable
            
            #### ğŸ§ **Linux** (All architectures: x64, ARM64, ARMv7)
            - **x64 (amd64):**
              - `xibe-chat-linux-x64-v${{ inputs.version }}-${{ inputs.build_number }}.deb` - Debian/Ubuntu package
              - `xibe-chat-linux-x64-v${{ inputs.version }}-${{ inputs.build_number }}.rpm` - Fedora/RHEL package
              - `xibe-chat-linux-x64-v${{ inputs.version }}-${{ inputs.build_number }}.AppImage` - Universal Linux app
              - `xibe-chat-linux-x64-v${{ inputs.version }}-${{ inputs.build_number }}.zip` - Portable ZIP
            - **ARM64 (aarch64):**
              - `xibe-chat-linux-arm64-v${{ inputs.version }}-${{ inputs.build_number }}.deb` - Debian/Ubuntu package
              - `xibe-chat-linux-arm64-v${{ inputs.version }}-${{ inputs.build_number }}.rpm` - Fedora/RHEL package
              - `xibe-chat-linux-arm64-v${{ inputs.version }}-${{ inputs.build_number }}.AppImage` - Universal Linux app
              - `xibe-chat-linux-arm64-v${{ inputs.version }}-${{ inputs.build_number }}.zip` - Portable ZIP
            - **ARMv7 (armhf):**
              - `xibe-chat-linux-armv7-v${{ inputs.version }}-${{ inputs.build_number }}.deb` - Debian/Ubuntu package
              - `xibe-chat-linux-armv7-v${{ inputs.version }}-${{ inputs.build_number }}.rpm` - Fedora/RHEL package
              - `xibe-chat-linux-armv7-v${{ inputs.version }}-${{ inputs.build_number }}.AppImage` - Universal Linux app
              - `xibe-chat-linux-armv7-v${{ inputs.version }}-${{ inputs.build_number }}.zip` - Portable ZIP
            
            #### ğŸ“± **iOS**
            - `xibe-chat-ios-unsigned-v${{ inputs.version }}-${{ inputs.build_number }}.ipa` - Unsigned IPA (requires signing)
            
            ---
            
            ### ğŸ“‹ Installation Instructions
            
            #### Android
            1. Download the APK file
            2. Enable "Install from Unknown Sources" in Settings
            3. Tap the APK to install
            
            #### Windows NSIS Installer (Recommended for Direct Install)
            1. Download the `.exe` installer file for your architecture (x64 or arm64)
            2. Double-click to run the installer
            3. Follow the installation wizard
            4. Desktop and Start Menu shortcuts will be created automatically
            
            #### Windows MSIX for Microsoft Store
            1. Download the `xibe-chat-windows-universal-store-*.msix` file
            2. This is an **unsigned universal package** ready for Microsoft Store submission
            3. Upload directly to Microsoft Partner Center - Microsoft will sign it with their certificate
            4. **Note:** This package cannot be installed directly without the Microsoft Store signature
            
            #### Windows Portable
            1. Download and extract the ZIP file for your architecture
            2. Run `xibe_chat.exe`
            
            #### macOS
            1. Download the appropriate DMG for your Mac (x64 for Intel, arm64 for Apple Silicon)
            2. Open the DMG and drag to Applications
            3. Right-click and select "Open" on first launch (if unsigned)
            
            #### Linux DEB (Debian/Ubuntu)
            1. Download the DEB file for your architecture
            2. Run: `sudo dpkg -i xibe-chat-linux-*-v*.deb`
            
            #### Linux RPM (Fedora/RHEL/openSUSE)
            1. Download the RPM file for your architecture
            2. Run: `sudo rpm -i xibe-chat-linux-*-v*.rpm`
            
            #### Linux AppImage
            1. Download the AppImage for your architecture
            2. Make it executable: `chmod +x xibe-chat-linux-*-v*.AppImage`
            3. Run: `./xibe-chat-linux-*-v*.AppImage`
            
            #### Linux ZIP (Portable)
            1. Download the ZIP file for your architecture
            2. Extract: `unzip xibe-chat-linux-*-v*.zip`
            3. Run: `./xibe_chat`
            
            #### iOS
            1. IPA requires proper signing for installation
            2. Use Xcode or third-party signing tools
            
            ---
            
            ### âœ¨ Features
            - ğŸ¤– AI-powered chat with multiple models
            - ğŸ’¬ Multiple conversation threads
            - ğŸŒ“ Dark/Light theme support
            - ğŸ“ Markdown message rendering
            - ğŸ’¾ Local chat history
            - ğŸ” Web search integration
            - ğŸ¨ Beautiful cross-platform UI
            
            ### ğŸ› ï¸ Technical Details
            - **Flutter Version**: Latest Stable
            - **Build Date**: ${{ github.event.repository.updated_at }}
            - **Commit**: ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup artifacts
        if: always()
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            android-builds
            windows-*-builds
            macos-*-builds
            linux-*-builds
            ios-builds
